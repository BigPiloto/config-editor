<!-- frontend/templates/choose_lang.html -->
{% extends "base.html" %}
{% block title %}{{ T("choose_lang.title") }}{% endblock %}

{% block content %}
<div class="login-wrap">
  <div class="card login-card">
    <header class="card-head row">
      <h2>{{ T("choose_lang.title") }}</h2>
    </header>

    <form id="lang-form" class="form">
      <div class="form-row">
        <label for="lang-select" class="muted">{{ T("choose_lang.label") }}</label>
        <select id="lang-select" name="language" class="input" required autofocus onchange="onLangChange(this.value)">
          <option value="en" {% if current_lang == "en" %}selected{% endif %}>English</option>
          <option value="pt-BR" {% if current_lang == "pt-BR" %}selected{% endif %}>PortuguÃªs (Brasil)</option>
        </select>
      </div>

      <div class="form-row">
        <button class="btn primary w-full" type="submit">
          {{ T("btn.confirm") }}
        </button>
      </div>
    </form>
  </div>
</div>

<script id="has-user" type="application/json">{{ has_user | tojson }}</script>
<script>
  const hasUser = JSON.parse(document.getElementById('has-user').textContent);

  async function onLangChange(code) {
    try {
      const res = await fetch("{{ request.url_for('set_language') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ language: code })
      });
      if (!res.ok) throw new Error("Failed");
      window.location.reload();
    } catch (e) {
      (window.swalCenter || Swal).fire({
        icon: "error",
        title: "{{ T('ui.error') }}",
        text: "{{ T('errors.http_error') }}"
      });
    }
  }

  document.getElementById("lang-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const lang = document.getElementById("lang-select").value;
    try {
      const res = await fetch("{{ request.url_for('set_language') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ language: lang })
      });
      if (!res.ok) throw new Error("Failed");
      (window.swalCenter || Swal).fire({
        icon: "success",
        title: "{{ T('choose_lang.success_title') }}",
        text: "{{ T('choose_lang.success') }}"
      }).then(() => {
        window.location.href = hasUser ? "{{ request.url_for('login') }}" : "{{ request.url_for('setup') }}";
      });
    } catch {
      (window.swalCenter || Swal).fire({
        icon: "error",
        title: "{{ T('ui.error') }}",
        text: "{{ T('errors.http_error') }}"
      });
    }
  });
</script>
{% endblock %}
