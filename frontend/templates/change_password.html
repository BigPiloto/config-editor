<!-- frontend/templates/change_password.html -->
{% extends "base.html" %}

{% block title %}{{ T("app.menu.change_pass") }} · {{ T("app.title") }}{% endblock %}

{% block content %}
<div class="login-wrap">
  <div class="card login-card">
    <header class="card-head row" style="justify-content: space-between; align-items: center;">
      <div class="row" style="gap:10px; align-items:center;">
        <h2>{{ T("app.menu.change_pass") }}</h2>
        <span class="tag info">{{ T(totp_required and "2fa.enabled" or "2fa.disabled") }}</span>
      </div>
      <a href="/editor" class="btn">{{ T("btn.back") }}</a>
    </header>

    <form id="form-change-password" method="post" action="/change-password" class="form" autocomplete="off">
      <div class="form-row">
        <label class="muted">{{ T("auth.current_pass") }}</label>
        <input id="current" class="input" type="password" name="current" placeholder="••••••••" autocomplete="current-password" autofocus required>
        <small class="hint" id="caps-hint-current" hidden>{{ T("auth.caps_on") }}</small>
      </div>

      <div class="form-row">
        <label class="muted">{{ T("auth.new_pass") }}</label>
        <input id="new_password" class="input" type="password" name="new_password" placeholder="••••••••" autocomplete="new-password" required>
        <small class="hint" id="caps-hint-new" hidden>{{ T("auth.caps_on") }}</small>
      </div>

      <div class="form-row">
        <label class="muted">{{ T("auth.confirm_pass") }}</label>
        <input id="confirm_password" class="input" type="password" name="confirm_password" placeholder="••••••••" autocomplete="new-password" required>
        <small class="hint" id="caps-hint-confirm" hidden>{{ T("auth.caps_on") }}</small>
      </div>

      {% if totp_required %}
      <div class="form-row">
        <label class="muted">{{ T("auth.2fa_code") }}</label>
        <input id="totp" class="input" name="totp" placeholder="000000" inputmode="numeric" pattern="\d{6}" maxlength="6" autocomplete="one-time-code" required>
      </div>
      {% endif %}

      <div class="form-row">
        <button id="btn-change-password" class="btn primary w-full" type="submit">{{ T("btn.change") }}</button>
      </div>
    </form>
  </div>
</div>

<script>
  // --- CapsLock hint ---
  let capsOn = null;
  function captureCaps(e) {
    if (e && e.getModifierState) {
      capsOn = e.getModifierState('CapsLock');
      const active = document.activeElement;
      if (active && active.dataset && active.dataset.capsHintId) {
        const hint = document.getElementById(active.dataset.capsHintId);
        if (hint) hint.hidden = !(capsOn === true);
      }
    }
  }
  window.addEventListener('keydown', captureCaps, true);
  window.addEventListener('keyup',   captureCaps, true);

  function bindCaps(inputId, hintId) {
    const input = document.getElementById(inputId);
    const hint  = document.getElementById(hintId);
    if (!input || !hint) return;
    input.dataset.capsHintId = hintId;
    input.addEventListener('focus', () => { hint.hidden = !capsOn; });
    input.addEventListener('keydown', captureCaps);
    input.addEventListener('keyup',   captureCaps);
    input.addEventListener('blur', () => { hint.hidden = true; });
  }
  bindCaps('current', 'caps-hint-current');
  bindCaps('new_password', 'caps-hint-new');
  bindCaps('confirm_password', 'caps-hint-confirm');

  // --- OTP só números ---
  const otp = document.getElementById('totp');
  if (otp) {
    otp.addEventListener('input', () => {
      otp.value = otp.value.replace(/\D/g,'').slice(0,6);
    });
  }

  function validateNotSamePassword(form) {
    const cur = form.querySelector('#current')?.value || '';
    const neu = form.querySelector('#new_password')?.value || '';

    if (cur && neu && cur === neu) {
      (window.swalCenter || Swal).fire({
        icon: 'error',
        title: "{{ T('errors.title') }}",
        text: "{{ T('errors.password_same_as_current') }}"
      });
      return false;
    }
    return true;
  }

  // --- interceptar o POST do form (robusto, sem optional chaining em atribuição) ---
  (function () {
    function bindChangePasswordForm() {
      const form = document.getElementById('form-change-password');
      if (!form) return;

      // evita duplo bind
      if (form.dataset.jsBound === '1') return;
      form.dataset.jsBound = '1'; // ✅ sem optional chaining na esquerda

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        const submitBtn = e.submitter || form.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = true;

        if (!validateNotSamePassword(form)) {
          if (submitBtn) submitBtn.disabled = false;
          return false;
        }

        const otp = document.getElementById('totp');

        try {
          const url = form.getAttribute('action') || '/change-password';
          const formData = new FormData(form);
          const payload  = new URLSearchParams(formData);

          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: payload
          });

          // força parse seguro de JSON
          let data;
          try { data = await res.json(); }
          catch { data = { ok: false, error: "{{ T('errors.unknown') }}" }; }

          if (data && data.ok) {
            (window.swalCenter || Swal).fire({
              icon: 'success',
              title: "{{ T('success.title') }}",
              text: (data.msg || "{{ T('success.password_changed') }}"),
              confirmButtonText: "{{ T('btn.back_editor') }}"
            }).then(() => { window.location.href = '/editor'; });
          } else {
            (window.swalCenter || Swal).fire({
              icon: 'error',
              title: "{{ T('errors.title') }}",
              text: (data && data.error) ? data.error : "{{ T('errors.unknown') }}"
            });

            // zera campos sensíveis
            form.querySelector('#current') && (form.querySelector('#current').value = '');
            form.querySelector('#new_password') && (form.querySelector('#new_password').value = '');
            form.querySelector('#confirm_password') && (form.querySelector('#confirm_password').value = '');
            if (otp) otp.value = '';
          }
        } catch (err) {
          (window.swalCenter || Swal).fire({
            icon: 'error',
            title: "{{ T('errors.title') }}",
            text: "{{ T('errors.internal_server_error') }}"
          });
        } finally {
          if (submitBtn) submitBtn.disabled = false;
        }

        return false; // redundância
      });
    }

    // Se o script vier antes do form por algum motivo, garante bind após DOM pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bindChangePasswordForm);
    } else {
      bindChangePasswordForm();
    }
  })();
</script>
{% endblock %}